// JS helper for the Generate Codes page
// - Toggles fields depending on code type (certification / promotion)
// - Updates discount symbol
// - Initializes Select2 where needed
// - Handles form submit state (disable button + spinner)

(function () {
    function $(sel, ctx) { return (ctx || document).querySelector(sel); }
    function $all(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }

    document.addEventListener('DOMContentLoaded', function () {
        var form = $('#generate-codes-form');
        if (!form) return;

        function getField(candidates) {
            for (var i = 0; i < candidates.length; i++) {
                var el = document.querySelector(candidates[i]);
                if (el) return el;
            }
            return null;
        }

        // Try several possible selectors (id generated by Django or custom widget ids)
        var codeTypeSelect = getField(['#id_code_type', '#code-type-selector', '#id-code-type', '[name="code_type"]']);
        var promotionFields = $all('.promotion-field');
        var certificationFields = $all('.certification-field');
        var discountType = getField(['#id_discount_type', '#discount-type-field', '#id-discount-type', '[name="discount_type"]']);
        var discountSymbolEls = $all('.discount-type-symbol');
        var submitBtn = form.querySelector('button[type="submit"]');

        function setVisibilityForType(type) {
            if (type === 'promotion') {
                promotionFields.forEach(function (el) { el.style.display = ''; });
                certificationFields.forEach(function (el) { el.style.display = 'none'; });
            } else if (type === 'certification') {
                promotionFields.forEach(function (el) { el.style.display = 'none'; });
                certificationFields.forEach(function (el) { el.style.display = ''; });
            } else {
                // default: hide promotion specifics, show certification basics
                promotionFields.forEach(function (el) { el.style.display = 'none'; });
                certificationFields.forEach(function (el) { el.style.display = ''; });
            }
        }

        // Update symbol when discount type changes
        function updateDiscountSymbol() {
            var symbol = '%';
            if (discountType && discountType.value === 'fixed') symbol = 'FCFA';
            discountSymbolEls.forEach(function (el) { el.textContent = symbol; });
        }

        // Initial visibility
        if (codeTypeSelect) {
            setVisibilityForType(codeTypeSelect.value);
            codeTypeSelect.addEventListener('change', function (e) {
                setVisibilityForType(e.target.value);
            });
        }

        if (discountType) {
            discountType.addEventListener('change', updateDiscountSymbol);
            updateDiscountSymbol();
        }

        // Initialize any remaining select2 fields in case loaded after template
        try {
            if (window.jQuery && window.jQuery().select2) {
                window.jQuery('.select2').not('.select2-hidden-accessible').select2({ width: '100%' });
            }
        } catch (err) {
            console.warn('Select2 init failed', err);
        }

        // Submit handler: perform AJAX submit and show modal with results
        if (form && submitBtn) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                // disable submit and show spinner
                submitBtn.disabled = true;
                var origHtml = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' + (origHtml || 'Traitement...');

                // Prepare form data
                var fd = new FormData(form);

                // CSRF token
                var csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
                var csrf = csrfInput ? csrfInput.value : null;

                // Send via fetch
                fetch(form.action || window.location.href, {
                    method: 'POST',
                    headers: Object.assign({}, csrf ? { 'X-CSRFToken': csrf } : {}, {
                        'X-Requested-With': 'XMLHttpRequest'
                    }),
                    body: fd,
                    credentials: 'same-origin'
                }).then(function (resp) {
                    return resp.json().then(function (data) { return { status: resp.status, ok: resp.ok, data: data }; });
                }).then(function (res) {
                    if (res.ok && res.data && res.data.success) {
                        // Populate modal with codes
                        var list = document.getElementById('generated-codes-list');
                        list.innerHTML = '';
                        res.data.codes.forEach(function (c) {
                            var div = document.createElement('div');
                            div.className = 'code-item mb-2';
                            div.innerHTML = '<strong>' + (c.code || '') + '</strong>' + (c.discount ? (' <span class="badge bg-secondary ms-2">' + c.discount + '</span>') : '');
                            list.appendChild(div);
                        });

                        var viewLink = document.getElementById('view-codes-link');
                        if (viewLink && res.data.view_url) {
                            viewLink.href = res.data.view_url;
                            viewLink.classList.remove('d-none');
                        }

                        // show modal
                        var modalEl = document.getElementById('generatedCodesModal');
                        if (modalEl) {
                            var modal = new bootstrap.Modal(modalEl);
                            modal.show();
                        }
                    } else {
                        // show errors
                        var errors = res.data && res.data.errors ? res.data.errors : { _server: ['Une erreur est survenue'] };
                        var alertEl = document.getElementById('generated-codes-alert');
                        if (alertEl) {
                            alertEl.classList.remove('d-none');
                            alertEl.innerHTML = '';
                            Object.keys(errors).forEach(function (k) {
                                errors[k].forEach(function (msg) {
                                    var p = document.createElement('div');
                                    p.textContent = msg;
                                    alertEl.appendChild(p);
                                });
                            });
                        } else {
                            alert('Erreur: ' + JSON.stringify(errors));
                        }
                    }
                }).catch(function (err) {
                    console.error('AJAX generate codes error', err);
                    alert('Une erreur réseau est survenue.');
                }).finally(function () {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = origHtml;
                });
            });
        }
    });
})();
document.addEventListener('DOMContentLoaded', function() {
    // Fonction pour afficher/masquer les champs en fonction du type de code sélectionné
    function toggleCodeFields() {
        const codeType = document.getElementById('code-type-selector').value;
        const certificationFields = document.querySelectorAll('.certification-field');
        const promotionFields = document.querySelectorAll('.promotion-field');
        
        if (codeType === 'certification') {
            // Afficher les champs de certification
            certificationFields.forEach(field => {
                field.style.display = 'block';
            });
            // Masquer les champs de promotion
            promotionFields.forEach(field => {
                field.style.display = 'none';
                // Réinitialiser les champs obligatoires
                const inputs = field.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.required = false;
                });
            });
        } else if (codeType === 'promotion') {
            // Afficher les champs de promotion
            promotionFields.forEach(field => {
                field.style.display = 'block';
                // Rendre les champs obligatoires
                const requiredInputs = field.querySelectorAll('input[required], select[required], textarea[required]');
                requiredInputs.forEach(input => {
                    input.required = true;
                });
            });
            // Masquer les champs de certification
            certificationFields.forEach(field => {
                field.style.display = 'none';
                // Réinitialiser les champs obligatoires
                const inputs = field.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.required = false;
                });
            });
        }
    }

    // Écouter les changements sur le sélecteur de type de code
    const codeTypeSelector = document.getElementById('code-type-selector');
    if (codeTypeSelector) {
        codeTypeSelector.addEventListener('change', toggleCodeFields);
        // Appeler la fonction une fois au chargement de la page
        toggleCodeFields();
    }

    // Gérer la soumission du formulaire
    const form = document.getElementById('generate-codes-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const codeType = document.getElementById('code-type-selector').value;
            let isValid = true;
            
            // Validation des champs obligatoires en fonction du type de code
            if (codeType === 'certification') {
                const subscription = document.getElementById('subscription-field');
                if (subscription && !subscription.value) {
                    isValid = false;
                    alert('Veuillez sélectionner un abonnement pour les codes de certification.');
                }
            } else if (codeType === 'promotion') {
                const product = document.getElementById('product-field');
                const discountValue = document.getElementById('discount-value-field');
                
                if (product && !product.value) {
                    isValid = false;
                    alert('Veuillez sélectionner un produit pour les codes promotionnels.');
                }
                
                if (discountValue && !discountValue.value) {
                    isValid = false;
                    alert('Veuillez saisir une valeur de réduction pour les codes promotionnels.');
                }
            }
            
            if (!isValid) {
                e.preventDefault();
                return false;
            }
            
            // Afficher un indicateur de chargement
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Génération en cours...';
            }
            
            return true;
        });
    }

    // Initialiser Select2 si disponible
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Sélectionnez une option...',
            allowClear: true
        });
    }

    // Dynamic population of products/subscriptions when store changes
    (function() {
        function findEl(selectors) {
            for (var i = 0; i < selectors.length; i++) {
                var el = document.querySelector(selectors[i]);
                if (el) return el;
            }
            return null;
        }

        var storeSelect = findEl(['#id_store', '#store-field', '[name="store"]']);
        var productSelect = findEl(['#id_product', '#product-field', '[name="product"]']);
        var subscriptionSelect = findEl(['#id_subscription', '#subscription-field', '[name="subscription"]']);

        function clearSelect(sel, placeholderText) {
            if (!sel) return;
            sel.innerHTML = '';
            var opt = document.createElement('option');
            opt.value = '';
            opt.textContent = placeholderText || '---';
            sel.appendChild(opt);
        }

        function populateSelect(sel, items, idKey, textKey) {
            if (!sel) return;
            clearSelect(sel, sel.getAttribute('data-placeholder') || 'Sélectionnez...');
            items.forEach(function(it) {
                var o = document.createElement('option');
                o.value = it[idKey];
                o.textContent = it[textKey];
                sel.appendChild(o);
            });

            // If using Select2, refresh
            try {
                if (window.jQuery && window.jQuery(sel).data('select2')) {
                    window.jQuery(sel).trigger('change.select2');
                }
            } catch (e) { /* ignore */ }
        }

        function fetchForStore(storeId) {
            if (!storeId) {
                // clear both
                clearSelect(productSelect, 'Sélectionnez un produit...');
                clearSelect(subscriptionSelect, 'Sélectionnez un abonnement...');
                return;
            }

            // Fetch products (ask server to filter by store)
            fetch('/api/products/?limit=200&store=' + encodeURIComponent(storeId), {
                credentials: 'same-origin'
            }).then(function(r){ return r.json(); }).then(function(data){
                var items = (data && data.results) ? data.results : [];
                var mapped = items.map(function(p){ return { id: p.id, name: p.name }; });
                populateSelect(productSelect, mapped, 'id', 'name');
            }).catch(function(){
                // on error, clear
                clearSelect(productSelect, 'Erreur lors du chargement');
            });

            // Fetch subscriptions
            fetch('/stores/api/subscriptions/?store=' + encodeURIComponent(storeId), {
                credentials: 'same-origin'
            }).then(function(r){ return r.json(); }).then(function(data){
                var items = (data && data.results) ? data.results : [];
                var mapped = items.map(function(s){ return { id: s.id, name: (s.plan || 'Abonnement') + ' — ' + (s.status || '') }; });
                populateSelect(subscriptionSelect, mapped, 'id', 'name');
            }).catch(function(){
                clearSelect(subscriptionSelect, 'Erreur lors du chargement');
            });
        }

        if (storeSelect) {
            storeSelect.addEventListener('change', function(e){
                var storeId = e.target.value;
                fetchForStore(storeId);
            });

            // Trigger initial load if a store is already selected
            if (storeSelect.value) fetchForStore(storeSelect.value);
        }
    })();
});
