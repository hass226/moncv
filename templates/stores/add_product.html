{% extends 'base.html' %}

{% block title %}Ajouter un produit{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">
                    <i class="bi bi-plus-circle"></i> Ajouter un produit
                </h2>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">Nom du produit *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger small">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.price.id_for_label }}" class="form-label">Prix *</label>
                        {{ form.price }}
                        {% if form.price.errors %}
                            <div class="text-danger small">{{ form.price.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.currency.id_for_label }}" class="form-label">Devise *</label>
                        {{ form.currency }}
                        {% if form.currency.errors %}
                            <div class="text-danger small">{{ form.currency.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.stock.id_for_label }}" class="form-label">Stock disponible *</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" onclick="decrementStock()">-</button>
                            {{ form.stock }}
                            <button type="button" class="btn btn-outline-secondary" onclick="incrementStock()">+</button>
                        </div>
                        {% if form.stock.errors %}
                            <div class="text-danger small">{{ form.stock.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Quantité disponible en stock. Mettez 0 si le produit est en rupture de stock.</small>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.category.id_for_label }}" class="form-label">Catégorie</label>
                        {{ form.category }}
                        <small class="form-text text-muted">Choisissez la catégorie du produit. Si vous laissez vide, il apparaîtra dans "Autres produits".</small>
                        {% if form.category.errors %}
                            <div class="text-danger small">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.image.id_for_label }}" class="form-label">Image du produit *</label>
                        {{ form.image }}
                        <div id="image-preview" class="mt-2"></div>
                        {% if form.image.errors %}
                            <div class="text-danger small">{{ form.image.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Annuler</a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Ajouter le produit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.input-group button {
    width: 40px;
    font-weight: bold;
}
.input-group input {
    text-align: center;
}
</style>
<script>
// Fonctions pour gérer l'incrémentation/décrémentation du stock
function incrementStock() {
    const stockInput = document.getElementById('{{ form.stock.id_for_label }}');
    let value = parseInt(stockInput.value) || 0;
    stockInput.value = value + 1;
}

function decrementStock() {
    const stockInput = document.getElementById('{{ form.stock.id_for_label }}');
    let value = parseInt(stockInput.value) || 0;
    if (value > 0) {
        stockInput.value = value - 1;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Validation côté client pour le champ stock
    const stockInput = document.getElementById('{{ form.stock.id_for_label }}');
    if (stockInput) {
        stockInput.addEventListener('change', function(e) {
            const value = parseInt(e.target.value);
            if (isNaN(value) || value < 0) {
                e.target.value = '0';
            }
        });
    }
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    const imagePreview = document.getElementById('image-preview');
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Clear previous preview
                    imagePreview.innerHTML = '';
                    
                    // Create image element
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '300px';
                    img.style.borderRadius = '4px';
                    img.style.border = '1px solid #dee2e6';
                    img.style.padding = '5px';
                    img.style.display = 'block';
                    img.style.marginBottom = '10px';
                    
                    // Add image to preview
                    imagePreview.appendChild(img);
                    
                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-outline-danger';
                    removeBtn.innerHTML = '<i class="bi bi-trash"></i> Supprimer';
                    removeBtn.onclick = function() {
                        imageInput.value = '';
                        imagePreview.innerHTML = '';
                    };
                    imagePreview.appendChild(removeBtn);
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock %}
