{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard - {{ store.name }} - MYMEDAGA{% endblock %}

{% block extra_css %}
<style>
    /* Fond général plus doux pour le dashboard */
    body {
        background: radial-gradient(circle at top, #f3e9ff 0, #f8f9ff 40%, #fdfdfd 100%);
    }

    .dashboard-hero-card {
        border-radius: 24px;
        border: none;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(236, 72, 153, 0.9));
        color: #fff;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
        overflow: hidden;
        position: relative;
    }

    .dashboard-hero-card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle at 10% 0, rgba(255, 255, 255, 0.25), transparent 55%),
                    radial-gradient(circle at 90% 100%, rgba(56, 189, 248, 0.25), transparent 55%);
        opacity: 0.8;
        pointer-events: none;
    }

    .dashboard-hero-particles {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 0;
    }

    .dashboard-hero-card .card-body {
        position: relative;
        z-index: 1;
    }

    .dashboard-hero-title {
        font-weight: 800;
        letter-spacing: 0.03em;
    }

    .dashboard-hero-subtitle {
        opacity: 0.9;
    }

    .dashboard-alert-store {
        border-radius: 16px;
        background: linear-gradient(120deg, rgba(59, 130, 246, 0.06), rgba(236, 72, 153, 0.05));
        border: 1px solid rgba(129, 140, 248, 0.2);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    .product-card {
        position: relative;
        border-radius: 18px;
        border: none;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.12);
        transform: translateY(10px);
        opacity: 0;
        transition: transform 0.4s ease, box-shadow 0.3s ease, opacity 0.4s ease;
    }

    .product-card.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .product-card:hover {
        transform: translateY(-6px) scale(1.01);
        box-shadow: 0 24px 55px rgba(15, 23, 42, 0.28);
    }

    .product-card .card-img-top {
        max-height: 190px;
        object-fit: cover;
    }

    .btn-outline-primary,
    .btn-outline-danger {
        transition: all 0.25s ease;
        border-radius: 999px;
    }

    .btn-outline-primary:hover,
    .btn-outline-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
    }

    .btn-gradient-primary {
        background: linear-gradient(135deg, #4f46e5, #ec4899);
        border: none;
        color: #fff;
        box-shadow: 0 14px 35px rgba(79, 70, 229, 0.55);
        border-radius: 999px;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .btn-gradient-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(79, 70, 229, 0.75);
        color: #fff;
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: 800;
    }

    .stat-card {
        border-radius: 18px !important;
        border: none !important;
        background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.95));
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.16);
        transform: translateY(10px);
        opacity: 0;
        transition: transform 0.4s ease, box-shadow 0.3s ease, opacity 0.4s ease;
    }

    .stat-card.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
    }

    .section-title {
        font-weight: 700;
        letter-spacing: 0.04em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: linear-gradient(90deg, #4f46e5, #ec4899);
    }

    @keyframes floatPulse {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-4px);
        }
    }

    .dashboard-hero-cta {
        animation: floatPulse 3s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="alert alert-info dashboard-alert-store d-flex justify-content-between align-items-center mb-3 fade-section">
    <span class="d-flex align-items-center">
        <i class="bi bi-shop me-2" style="font-size: 1.3rem;"></i>
        <span>
            <strong>Vue client en temps réel</strong><br>
            <small>Accédez à votre boutique publique pour voir ce que vos clients voient.</small>
        </span>
    </span>
    <a href="{% url 'store_detail' store.id %}" class="btn btn-gradient-primary btn-sm dashboard-hero-cta">
        <i class="bi bi-eye me-1"></i> Voir ma boutique
    </a>
</div>
<div class="row mb-4 fade-section">
    <div class="col-12">
        <div class="card dashboard-hero-card fade-section card-tilt">
            <div class="dashboard-hero-particles" id="dashboard-hero-particles"></div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        {% if store.logo %}
                            <img src="{{ store.logo.url }}" alt="{{ store.name }}" class="store-logo mb-3">
                        {% else %}
                            <div class="store-logo bg-secondary d-flex align-items-center justify-content-center mb-3">
                                <i class="bi bi-shop text-white" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-9">
                        <h1 class="display-5 dashboard-hero-title">{{ store.name }}</h1>
                        {% if store.description %}
                            <p class="lead dashboard-hero-subtitle">{{ store.description }}</p>
                        {% endif %}
                        <p class="text-light-50 mb-1">
                            <i class="bi bi-whatsapp text-success"></i> {{ store.whatsapp_number }}
                        </p>
                        <div class="mt-3">
                            <a href="{% url 'store_detail' store.id %}" class="btn btn-light text-primary rounded-pill me-2">
                                <i class="bi bi-eye me-2"></i>Voir ma boutique
                            </a>
                            <a href="{% url 'edit_store' %}" class="btn btn-outline-light rounded-pill">
                                <i class="bi bi-pencil me-2"></i>Modifier
                            </a>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-6 col-md-3">
                                <div class="card text-center stat-card">
                                    <div class="card-body">
                                        <div class="stat-number">{{ total_products|default:0 }}</div>
                                        <div class="stat-label">Produits</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center stat-card">
                                    <div class="card-body">
                                        <div class="stat-number">{{ total_views|default:0 }}</div>
                                        <div class="stat-label">Vues</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center stat-card">
                                    <div class="card-body">
                                        <div class="stat-number">{{ total_likes|default:0 }}</div>
                                        <div class="stat-label">Likes</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center stat-card">
                                    <div class="card-body">
                                        <div class="stat-number">{{ average_rating|default:0 }}<span style="font-size: 0.8rem;">/5</span></div>
                                        <div class="stat-label">Note ({{ total_reviews|default:0 }} avis)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center stat-card" style="background: linear-gradient(135deg, #f97316, #facc15); color: #0f172a;">
                                    <div class="card-body">
                                        <div class="stat-number" style="color: var(--primary-orange);">{{ total_orders|default:0 }}</div>
                                        <div class="stat-label">Commandes</div>
                                        <small class="text-light">{{ pending_orders|default:0 }} en attente</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center stat-card" style="background: linear-gradient(135deg, #22c55e, #4ade80); color: #052e16;">
                                    <div class="card-body">
                                        <div class="stat-number" style="color: var(--primary-green);">{{ total_revenue|default:0|floatformat:2 }} €</div>
                                        <div class="stat-label">Revenus</div>
                                        <small class="text-light">{{ completed_orders|default:0 }} livrées</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center fade-section">
                            {% if not store.is_verified %}
                            <a href="{% url 'subscribe' %}" class="btn btn-gradient-primary btn-animated">
                                <i class="bi bi-shield-check"></i> Vérifier ma boutique ({{ 8000|intcomma }} FCFA/6 mois)
                            </a>
                            {% else %}
                            <span class="badge" style="background: linear-gradient(135deg, var(--primary-yellow), var(--primary-orange)); padding: 10px 20px; font-size: 1rem;">
                                <i class="bi bi-check-circle-fill"></i> Boutique Vérifiée
                            </span>
                            {% endif %}
                            <a href="{% url 'promote' %}" class="btn btn-outline-light btn-animated">
                                <i class="bi bi-megaphone"></i> Promouvoir
                            </a>
                            <a href="{% url 'edit_store' %}" class="btn btn-outline-light btn-animated">
                                <i class="bi bi-pencil"></i> Modifier la boutique
                            </a>
                            <a href="{% url 'store_detail' store.id %}" class="btn btn-outline-light btn-animated" target="_blank">
                                <i class="bi bi-eye"></i> Voir la page publique
                            </a>
                        </div>
                        <div class="mt-3 fade-section">
                            <a href="{% url 'my_subscriptions' %}" class="btn btn-sm btn-outline-warning btn-animated">
                                <i class="bi bi-credit-card"></i> Mes abonnements
                            </a>
                            <a href="{% url 'my_promotions' %}" class="btn btn-sm btn-outline-info btn-animated">
                                <i class="bi bi-graph-up"></i> Mes promotions
                            </a>
                            <a href="{% url 'store_orders' %}" class="btn btn-sm btn-outline-success btn-animated">
                                <i class="bi bi-cart-check"></i> Mes commandes ({{ pending_orders|default:0 }})
                            </a>
                            <a href="{% url 'my_payments' %}" class="btn btn-sm btn-outline-primary btn-animated">
                                <i class="bi bi-wallet2"></i> Mes paiements
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
 </div>

 <div class="row mb-3 fade-section">
    <div class="col-lg-8 mb-3 mb-lg-0">
        <div class="card border-0 shadow-lg" style="border-radius: 20px; background: rgba(255,255,255,0.96);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between mb-2 dashboard-tip-toggle" style="cursor: pointer;">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary-yellow), var(--primary-orange)); color: #0f172a; font-size: 1.6rem;">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <h5 class="mb-0" style="font-family: 'Orbitron', sans-serif;">Astuce pour maximiser tes gains publicitaires</h5>
                    </div>
                    <i class="bi bi-chevron-up" id="dashboard-tip-chevron"></i>
                </div>
                <div id="dashboard-tip-content">
                    <div id="dashboard-ad-slot" class="ad-slot" style="min-height: 120px; display: block;">
                        <!-- Slot publicitaire du dashboard (Google AdSense) -->
                        <!-- Remplace CA-PUB-XXXX et data-ad-slot="YYYYYYYY" par tes vrais identifiants AdSense -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="CA-PUB-XXXX"
                             data-ad-slot="YYYYYYYY"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-lg" style="border-radius: 20px; background: rgba(15,23,42,0.98); color: #e5e7eb;">
            <div class="card-body p-4">
                <h5 class="mb-3 d-flex align-items-center gap-2">
                    <i class="bi bi-credit-card-2-back"></i>
                    Paiements Stripe
                </h5>

                {% if store.stripe_account_id %}
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge bg-success me-2">
                            <i class="bi bi-check-circle"></i> Compte Stripe connecté
                        </span>
                    </div>
                    <p class="small mb-2">
                        Vos paiements par carte (Stripe) sont activés. Les clients verront Stripe comme méthode de paiement disponible.
                    </p>
                    <p class="small text-muted mb-2">
                        Vous pouvez gérer les détails de votre compte directement dans votre espace Stripe.
                    </p>
                    <a href="{% url 'store_payment_settings' %}" class="btn btn-sm btn-outline-light w-100 mt-2">
                        <i class="bi bi-gear"></i> Paramètres FedaPay / Paystack
                    </a>
                {% else %}
                    <p class="small mb-3">
                        Connectez votre boutique à Stripe pour accepter les paiements par carte et recevoir vos revenus automatiquement sur votre compte bancaire.
                    </p>
                    <ul class="small mb-3" style="padding-left: 1.1rem;">
                        <li>Activation des paiements par carte pour vos clients</li>
                        <li>Versements automatiques sur votre compte Stripe</li>
                        <li>Commission plateforme de 1&nbsp;% gérée automatiquement</li>
                    </ul>
                    <a href="{% url 'create_stripe_account' %}" class="btn btn-sm btn-gradient-primary w-100 mb-2">
                        <i class="bi bi-plug"></i> Connecter mon compte Stripe
                    </a>
                    <a href="{% url 'store_payment_settings' %}" class="btn btn-sm btn-outline-light w-100 mb-2">
                        <i class="bi bi-gear"></i> Paramètres FedaPay / Paystack
                    </a>
                    <p class="small text-muted mt-1 mb-0">
                        Une fenêtre Stripe s'ouvrira pour compléter la configuration sécurisée de votre compte.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-3 fade-section">
    <div class="col-lg-6 mb-3 mb-lg-0">
        <div class="card border-0 shadow-lg" style="border-radius: 20px; background: rgba(255,255,255,0.96);">
            <div class="card-body p-4">
                <h5 class="mb-3 d-flex align-items-center gap-2">
                    <i class="bi bi-shield-check"></i>
                    Statut de certification
                </h5>
                {% if active_subscription %}
                    <p class="mb-1">
                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Boutique vérifiée</span>
                    </p>
                    <p class="small text-muted mb-1">
                        Abonnement actif jusqu'au {{ active_subscription.expires_at|date:"d/m/Y" }}.
                    </p>
                    <a href="{% url 'my_subscriptions' %}" class="btn btn-sm btn-outline-success btn-animated mt-2">
                        <i class="bi bi-credit-card"></i> Voir mes abonnements
                    </a>
                {% else %}
                    <p class="mb-2">Votre boutique n'est pas encore certifiée.</p>
                    <p class="small text-muted mb-2">La certification met en avant votre boutique dans le feed et rassure les acheteurs.</p>
                    <a href="{% url 'subscribe' %}" class="btn btn-sm btn-gradient-primary btn-animated">
                        <i class="bi bi-shield-check"></i> Vérifier ma boutique
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card border-0 shadow-lg" style="border-radius: 20px; background: rgba(255,255,255,0.96);">
            <div class="card-body p-4">
                <h5 class="mb-3 d-flex align-items-center gap-2">
                    <i class="bi bi-megaphone"></i>
                    Promotions actives
                </h5>
                {% if active_promotions %}
                    <ul class="list-unstyled mb-0">
                        {% for promo in active_promotions %}
                            <li class="mb-2">
                                <strong>
                                    {% if promo.product %}
                                        Produit : {{ promo.product.name }}
                                    {% elif promo.store %}
                                        Boutique : {{ promo.store.name }}
                                    {% endif %}
                                </strong><br>
                                <small class="text-muted">
                                    {% if promo.amount == 1000 %}
                                        Pack 1000 FCFA - 3 jours - ~500 personnes
                                    {% elif promo.amount == 2000 %}
                                        Pack 2000 FCFA - 7 jours - ~1500 personnes
                                    {% elif promo.amount == 3000 %}
                                        Pack 3000 FCFA - 14 jours - ~5000 personnes
                                    {% elif promo.amount == 5000 %}
                                        Pack 5000 FCFA - 30 jours - ~10000 personnes
                                    {% else %}
                                        {{ promo.amount }}
                                    {% endif %}
                                    • jusqu'au {{ promo.expires_at|date:"d/m/Y" }}
                                </small>
                            </li>
                        {% endfor %}
                    </ul>
                    <a href="{% url 'my_promotions' %}" class="btn btn-sm btn-outline-info btn-animated mt-2">
                        <i class="bi bi-graph-up"></i> Voir toutes mes promotions
                    </a>
                {% else %}
                    <p class="mb-2">Vous n'avez aucune promotion active pour le moment.</p>
                    <p class="small text-muted mb-2">Les promotions ne sont activées qu'après paiement et mettent en avant vos produits ou votre boutique dans le feed.</p>
                    <a href="{% url 'promote' %}" class="btn btn-sm btn-gradient-primary btn-animated">
                        <i class="bi bi-megaphone"></i> Créer une promotion
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-3 fade-section">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div class="d-flex flex-column">
                <h2 class="section-title mb-0">Mes produits ({{ products.count }})</h2>
                <p class="text-muted mb-0 mt-1 d-none d-md-block">Montants affichés dans votre devise actuelle : <strong>{{ current_currency }}</strong></p>
            </div>
            
            <div class="d-flex flex-column w-100 w-md-auto">
                <p class="text-muted mb-2 d-md-none text-center w-100">Devise : <strong>{{ current_currency }}</strong></p>
                <div class="d-flex flex-column flex-sm-row gap-2 w-100">
                    <a href="{% url 'add_category' %}" class="btn btn-outline-secondary btn-animated flex-grow-1 text-center">
                        <i class="bi bi-tags d-none d-sm-inline"></i> Catégorie
                    </a>
                    <a href="{% url 'add_product' %}" class="btn btn-gradient-primary btn-animated flex-grow-1 text-center" 
                       style="white-space: nowrap;">
                        <i class="bi bi-plus-circle"></i> Produit
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if products %}
    {% regroup products by category as products_by_category %}

    <!-- Filtres par catégorie -->
    <div class="row mb-3 fade-section">
        <div class="col-12">
            <div class="btn-group flex-wrap" id="category-filter" role="group" aria-label="Filtrer par catégorie">
                <button type="button" class="btn btn-sm btn-outline-secondary active" data-category-id="all">
                    Toutes les catégories
                </button>
                {% for group in products_by_category %}
                    {% if group.grouper %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-category-id="{{ group.grouper.id }}">
                        {{ group.grouper.name }} ({{ group.list|length }})
                    </button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    {% for group in products_by_category %}
        <div class="category-section" data-category-id="{% if group.grouper %}{{ group.grouper.id }}{% else %}none{% endif %}">
            <div class="row mb-2 fade-section">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <h3 class="section-title">
                        <i class="bi bi-tags"></i>
                        {% if group.grouper %}
                            {{ group.grouper.name }}
                        {% else %}
                            Autres produits
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0 small">
                        {{ group.list|length }} produit{% if group.list|length > 1 %}s{% endif %}
                    </p>
                </div>
            </div>

            <div class="row g-4 fade-section">
                {% for product in group.list %}
                <div class="col-md-4 col-lg-3">
                    <div class="card product-card h-100 card-tilt">
                        <img src="{{ product.image.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="card-text text-muted small">{{ product.description|truncatewords:10 }}</p>
                            <div class="mt-auto">
                                <p class="h5 text-primary mb-3 product-price"
                                   data-amount="{{ product.price }}"
                                   data-currency="{{ product.currency }}">
                                    {{ product.price }} {{ product.get_currency_display }}
                                </p>
                                <div class="d-grid gap-2">
                                    <a href="{% url 'edit_product' product.id %}" class="btn btn-sm btn-outline-primary btn-animated">
                                        <i class="bi bi-pencil"></i> Modifier
                                    </a>
                                    <a href="{% url 'delete_product' product.id %}" class="btn btn-sm btn-outline-danger btn-animated">
                                        <i class="bi bi-trash"></i> Supprimer
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="row g-4 fade-section">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> Vous n'avez pas encore de produits. 
                <a href="{% url 'add_product' %}" class="alert-link">Ajoutez-en un maintenant !</a>
            </div>
        </div>
    </div>
{% endif %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const statCards = document.querySelectorAll('.stat-card');
        const productCards = document.querySelectorAll('.product-card');
        const allCards = [...statCards, ...productCards];

        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.15
            });

            allCards.forEach(card => observer.observe(card));
        } else {
            allCards.forEach(card => card.classList.add('visible'));
        }

        const animateCounter = (element) => {
            const finalValue = parseFloat(element.textContent) || 0;
            let start = 0;
            const duration = 900;
            const startTime = performance.now();

            const isDecimal = !Number.isInteger(finalValue);

            const step = (now) => {
                const progress = Math.min((now - startTime) / duration, 1);
                const value = start + (finalValue - start) * progress;
                element.textContent = isDecimal ? value.toFixed(2) : Math.floor(value);
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            };

            requestAnimationFrame(step);
        };

        statCards.forEach(card => {
            const numberEl = card.querySelector('.stat-number');
            if (!numberEl) return;

            const originalText = numberEl.textContent;
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        animateCounter(numberEl);
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.3 });

            observer.observe(card);
        });

        const heroParticlesContainer = document.getElementById('dashboard-hero-particles');
        if (heroParticlesContainer) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            heroParticlesContainer.appendChild(canvas);

            const particles = [];
            const PARTICLE_COUNT = 30;

            const resizeCanvas = () => {
                canvas.width = heroParticlesContainer.clientWidth;
                canvas.height = heroParticlesContainer.clientHeight;
            };

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: 1 + Math.random() * 2.5,
                    dx: -0.25 + Math.random() * 0.5,
                    dy: -0.25 + Math.random() * 0.5,
                    o: 0.25 + Math.random() * 0.5
                });
            }

            const animateDashboardParticles = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += p.dx;
                    p.y += p.dy;

                    if (p.x < 0) p.x = canvas.width;
                    if (p.x > canvas.width) p.x = 0;
                    if (p.y < 0) p.y = canvas.height;
                    if (p.y > canvas.height) p.y = 0;

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(248, 250, 252, ${p.o.toFixed(2)})`;
                    ctx.fill();
                });
                requestAnimationFrame(animateDashboardParticles);
            };

            animateDashboardParticles();
        }

        const tipToggle = document.querySelector('.dashboard-tip-toggle');
        const tipContent = document.getElementById('dashboard-tip-content');
        const tipChevron = document.getElementById('dashboard-tip-chevron');

        if (tipToggle && tipContent && tipChevron) {
            tipToggle.addEventListener('click', function () {
                const isHidden = tipContent.style.display === 'none';
                tipContent.style.display = isHidden ? '' : 'none';
                tipChevron.classList.toggle('bi-chevron-up', isHidden);
                tipChevron.classList.toggle('bi-chevron-down', !isHidden);
            });
        }

        const dashboardAdSlot = document.getElementById('dashboard-ad-slot');
        if (dashboardAdSlot && 'IntersectionObserver' in window) {
            const adObserver = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        dashboardAdSlot.classList.add('ad-slot-visible');
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.3 });

            adObserver.observe(dashboardAdSlot);
        }
    });
</script>

<script>
// Filtre par catégorie dans "Mes produits" (affiche une seule catégorie à la fois)
    document.addEventListener('DOMContentLoaded', function () {
        const filterContainer = document.getElementById('category-filter');
        if (!filterContainer) return;

        const buttons = Array.from(filterContainer.querySelectorAll('button[data-category-id]'));
        const sections = Array.from(document.querySelectorAll('.category-section'));

        const showCategory = (categoryId) => {
            sections.forEach(section => {
                const secId = section.getAttribute('data-category-id');
                if (categoryId === 'all' || secId === categoryId) {
                    section.style.display = '';
                } else {
                    section.style.display = 'none';
                }
            });
        };

        filterContainer.addEventListener('click', function (event) {
            const btn = event.target.closest('button[data-category-id]');
            if (!btn) return;

            const categoryId = btn.getAttribute('data-category-id');

            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            showCategory(categoryId);
        });

        // État initial : toutes les catégories visibles
        showCategory('all');
    });
</script>
{% endblock %}
{% endblock %}
