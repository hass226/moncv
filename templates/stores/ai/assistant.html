{% extends 'base.html' %}
{% load static %}

{% block title %}Assistant IA - MYMEDAGA{% endblock %}

{% block extra_css %}
<style>
    .ai-hero-title {
        background: linear-gradient(135deg, #4f46e5, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .ai-hero-subtitle {
        color: rgba(248, 250, 252, 0.85);
    }

    .ai-tool-card {
        border-radius: 20px;
        border: none;
        background: radial-gradient(circle at top left, #f8fafc, #e2e8f0);
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.16);
        transform: translateY(12px);
        opacity: 0;
        transition: transform 0.35s ease, box-shadow 0.3s ease, opacity 0.35s ease, background 0.3s ease;
    }

    .ai-tool-card.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .ai-tool-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 22px 50px rgba(15, 23, 42, 0.26);
        background: radial-gradient(circle at top left, #ffffff, #e5e7eb);
    }

    .ai-panel-card {
        border-radius: 22px;
        border: none;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.2);
    }

    .ai-section-title {
        font-weight: 700;
        letter-spacing: 0.08em;
        font-size: 0.9rem;
        text-transform: uppercase;
        color: #94a3b8;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .ai-section-title::before {
        content: "";
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: linear-gradient(90deg, #4f46e5, #ec4899);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-3 fw-bold mb-3 ai-hero-title">
            ü§ñ ASSISTANT IA
        </h1>
        <p class="lead ai-hero-subtitle">Laissez l'IA vous aider √† vendre mieux !</p>
    </div>

    <div class="row">
        <!-- AI Tools -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-lg ai-panel-card" style="border-radius: 22px;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #7209B7, #4facfe); border: none;">
                    <h5 class="mb-0"><i class="bi bi-magic me-2"></i>Outils IA</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="ai-section-title">Outils IA</span>
                    </div>
                    <div class="row g-3">
                        <!-- Description Generator -->
                        <div class="col-md-6">
                            <div class="ai-tool-card p-4 text-center" onclick="openTool('description')">
                                <div class="mb-3">
                                    <i class="bi bi-file-text" style="font-size: 3rem; color: #7209B7;"></i>
                                </div>
                                <h6 class="fw-bold">Description de produit</h6>
                                <p class="small text-muted">G√©n√®re une description accrocheuse</p>
                            </div>
                        </div>

                        <!-- Price Optimizer -->
                        <div class="col-md-6">
                            <div class="ai-tool-card p-4 text-center" onclick="openTool('pricing')">
                                <div class="mb-3">
                                    <i class="bi bi-currency-dollar" style="font-size: 3rem; color: #00C896;"></i>
                                </div>
                                <h6 class="fw-bold">Prix optimal</h6>
                                <p class="small text-muted">Sugg√®re le meilleur prix</p>
                            </div>
                        </div>

                        <!-- Tags Generator -->
                        <div class="col-md-6">
                            <div class="ai-tool-card p-4 text-center" onclick="openTool('tags')">
                                <div class="mb-3">
                                    <i class="bi bi-tags" style="font-size: 3rem; color: #FF6B35;"></i>
                                </div>
                                <h6 class="fw-bold">√âtiquettes automatiques</h6>
                                <p class="small text-muted">G√©n√®re des tags SEO</p>
                            </div>
                        </div>

                        <!-- Translation -->
                        <div class="col-md-6">
                            <div class="ai-tool-card p-4 text-center" onclick="openTool('translation')">
                                <div class="mb-3">
                                    <i class="bi bi-translate" style="font-size: 3rem; color: #F7B801;"></i>
                                </div>
                                <h6 class="fw-bold">Traduction</h6>
                                <p class="small text-muted">Traduit vos descriptions</p>
                            </div>
                        </div>

                        <!-- Title Optimizer -->
                        <div class="col-md-6">
                            <div class="ai-tool-card p-4 text-center" onclick="openTool('title')">
                                <div class="mb-3">
                                    <i class="bi bi-type" style="font-size: 3rem; color: #E63946;"></i>
                                </div>
                                <h6 class="fw-bold">Titre optimis√©</h6>
                                <p class="small text-muted">Optimise vos titres SEO</p>
                            </div>
                        </div>

                        <!-- Marketing Text -->
                        <div class="col-md-6">
                            <div class="ai-tool-card p-4 text-center" onclick="openTool('marketing_text')">
                                <div class="mb-3">
                                    <i class="bi bi-megaphone" style="font-size: 3rem; color: #667eea;"></i>
                                </div>
                                <h6 class="fw-bold">Texte marketing</h6>
                                <p class="small text-muted">Cr√©e des textes accrocheurs</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool Form -->
            <div class="card border-0 shadow-lg mt-4 ai-panel-card" id="tool-form" style="border-radius: 22px; display: none;">
                <div class="card-body p-4">
                    <form id="ai-form" onsubmit="submitAIRequest(event)">
                        <input type="hidden" id="request-type" name="request_type">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Texte d'entr√©e</label>
                            <textarea name="input_text" id="input-text" class="form-control" rows="5" placeholder="Entrez votre texte ici..."></textarea>
                        </div>
                        <div class="mb-3" id="target-language-field" style="display: none;">
                            <label class="form-label fw-bold">Langue cible</label>
                            <select name="target_language" class="form-select">
                                <option value="en">Anglais</option>
                                <option value="fr">Fran√ßais</option>
                                <option value="es">Espagnol</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill">
                            <i class="bi bi-magic me-2"></i>G√©n√©rer avec l'IA
                        </button>
                    </form>
                </div>
            </div>

            <!-- Result -->
            <div class="card border-0 shadow-lg mt-4 ai-panel-card" id="ai-result" style="border-radius: 22px; display: none;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #00C896, #4facfe); border: none;">
                    <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>R√©sultat</h5>
                </div>
                <div class="card-body p-4">
                    <div id="result-content"></div>
                    <button class="btn btn-outline-primary mt-3 rounded-pill" onclick="copyResult()">
                        <i class="bi bi-clipboard me-2"></i>Copier
                    </button>
                </div>
            </div>
        </div>

        <!-- History -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-lg ai-panel-card" style="border-radius: 22px;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                    <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique</h6>
                </div>
                <div class="card-body p-3" style="max-height: 600px; overflow-y: auto;">
                    {% for req in recent_requests %}
                    <div class="p-3 mb-2 rounded-3" style="background: #f8f9fa;">
                        <div class="d-flex justify-content-between mb-1">
                            <strong class="small">{{ req.get_request_type_display }}</strong>
                            <span class="badge bg-{% if req.status == 'completed' %}success{% elif req.status == 'failed' %}danger{% else %}warning{% endif %}">
                                {{ req.get_status_display }}
                            </span>
                        </div>
                        <p class="small text-muted mb-0">{{ req.input_text|truncatewords:10 }}</p>
                        <small class="text-muted">{{ req.created_at|timesince }} ago</small>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-4">Aucun historique</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function openTool(toolType) {
    const formCard = document.getElementById('tool-form');
    formCard.style.display = 'block';
    formCard.classList.add('animate__fadeInUp');
    document.getElementById('request-type').value = toolType;
    document.getElementById('target-language-field').style.display = toolType === 'translation' ? 'block' : 'none';
    document.getElementById('ai-result').style.display = 'none';
    document.getElementById('input-text').focus();
}

function submitAIRequest(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;

    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>G√©n√©ration en cours...';
    
    fetch('{% url "ai_assistant" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur serveur (' + response.status + ')');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const output = (data.result && data.result.output_text) ? data.result.output_text : '';
            document.getElementById('result-content').innerHTML = `
                <div class="p-3 rounded-3" style="background: #f8f9fa;">
                    <p class="mb-0">${output.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            const resultCard = document.getElementById('ai-result');
            resultCard.style.display = 'block';
        } else {
            alert('Erreur: ' + (data.error || 'Une erreur est survenue lors de la g√©n√©ration IA'));
        }
    })
    .catch(err => {
        alert('Erreur: ' + err.message);
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

function copyResult() {
    const text = document.getElementById('result-content').innerText;
    navigator.clipboard.writeText(text);
    alert('Copi√© !');
}

document.addEventListener('DOMContentLoaded', function () {
    const toolCards = document.querySelectorAll('.ai-tool-card');

    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    obs.unobserve(entry.target);
                }
            });
        }, { threshold: 0.2 });

        toolCards.forEach(card => observer.observe(card));
    } else {
        toolCards.forEach(card => card.classList.add('visible'));
    }
});
</script>
{% endblock %}
{% endblock %}

