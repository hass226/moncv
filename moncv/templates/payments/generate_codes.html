{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Générer des codes de vérification" %}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    :root {
        --primary: #4361ee;
        --primary-hover: #3a56d4;
        --secondary: #6c757d;
        --light: #f8f9fa;
        --dark: #212529;
        --success: #20c997;
        --border-radius: 12px;
        --box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        --transition: all 0.3s ease;
    }
    
    body {
        background-color: #f5f7fb;
    }
    
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        transition: var(--transition);
        overflow: hidden;
        background: #ffffff;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background: linear-gradient(135deg, var(--primary), #5f6af0);
        color: white;
        border-bottom: none;
        padding: 1.5rem 2rem;
    }
    
    .form-control, .select2-container--default .select2-selection--single {
        border-radius: 8px;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        transition: var(--transition);
        height: auto;
    }
    
    .form-control:focus, .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.15);
    }
    
    .btn {
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 500;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn i {
        font-size: 1.1em;
    }
    
    .btn-primary {
        background-color: var(--primary);
        border: none;
    }
    
    .btn-primary:hover, .btn-primary:focus {
        background-color: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.6rem;
        color: var(--dark);
    }
    
    .help-text {
        font-size: 0.85rem;
        color: var(--secondary);
        margin-top: 0.3rem;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section h5 {
        color: var(--primary);
        margin-bottom: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-section h5 i {
        font-size: 1.2em;
    }

    /* Styles pour les champs conditionnels */
    .field-group {
        margin-bottom: 1.5rem;
    }

    .field-group.hidden {
        display: none;
    }

    /* Style pour les messages d'erreur */
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }

    /* Style pour les champs requis */
    .required-field::after {
        content: " *";
        color: #dc3545;
    }

    @media (max-width: 768px) {
        .card {
            margin: 0 -15px;
            border-radius: 0;
        }
        
        .form-section {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 py-lg-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <div class="card overflow-hidden">
                <div class="card-header text-center py-4">
                    <h2 class="h3 mb-2"><i class="bi bi-shield-lock me-2"></i>{% trans "Générer des codes de vérification" %}</h2>
                    <p class="mb-0 opacity-75">{% trans "Créez des codes uniques pour la vérification des paiements" %}</p>
                </div>
                <div class="card-body p-4 p-md-5">
                    <form method="post" id="generate-codes-form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Section Type de code -->
                        <div class="form-section mb-4">
                            <h5><i class="bi bi-tag"></i> {% trans "Type de code" %}</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.code_type.id_for_label }}" class="form-label required-field">
                                        {{ form.code_type.label }}
                                    </label>
                                    {{ form.code_type }}
                                    {% if form.code_type.help_text %}
                                        <small class="form-text text-muted">{{ form.code_type.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.code_type.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Section Boutique et Plan -->
                        <div class="form-section mb-4">
                            <h5><i class="bi bi-shop"></i> {% trans "Boutique et Plan" %}</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.store.id_for_label }}" class="form-label required-field">
                                        {{ form.store.label }}
                                    </label>
                                    {{ form.store }}
                                    {% if form.store.help_text %}
                                        <small class="form-text text-muted">{{ form.store.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.store.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-6 mb-3 certification-field">
                                    <label for="{{ form.plan_type.id_for_label }}" class="form-label required-field">
                                        {{ form.plan_type.label }}
                                    </label>
                                    {{ form.plan_type }}
                                    {% if form.plan_type.help_text %}
                                        <small class="form-text text-muted">{{ form.plan_type.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.plan_type.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6 mb-3 certification-field">
                                    <label for="{{ form.subscription.id_for_label }}" class="form-label">
                                        {{ form.subscription.label }}
                                    </label>
                                    {{ form.subscription }}
                                    {% if form.subscription.help_text %}
                                        <small class="form-text text-muted">{{ form.subscription.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.subscription.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Section Détails du code -->
                        <div class="form-section mb-4">
                            <h5><i class="bi bi-gear"></i> {% trans "Détails du code" %}</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.count.id_for_label }}" class="form-label required-field">
                                        {{ form.count.label }}
                                    </label>
                                    {{ form.count }}
                                    {% if form.count.help_text %}
                                        <small class="form-text text-muted">{{ form.count.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.count.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.days_valid.id_for_label }}" class="form-label required-field">
                                        {{ form.days_valid.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.days_valid }}
                                        <span class="input-group-text">{% trans "jours" %}</span>
                                    </div>
                                    {% if form.days_valid.help_text %}
                                        <small class="form-text text-muted">{{ form.days_valid.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.days_valid.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.usage_limit.id_for_label }}" class="form-label">
                                        {{ form.usage_limit.label }}
                                    </label>
                                    {{ form.usage_limit }}
                                    {% if form.usage_limit.help_text %}
                                        <small class="form-text text-muted">{{ form.usage_limit.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.usage_limit.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.max_attempts.id_for_label }}" class="form-label">
                                        {{ form.max_attempts.label }}
                                    </label>
                                    {{ form.max_attempts }}
                                    {% if form.max_attempts.help_text %}
                                        <small class="form-text text-muted">{{ form.max_attempts.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.max_attempts.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Section Détails du code promotionnel (visible uniquement pour les codes promotionnels) -->
                        <div class="form-section mb-4 promotion-field" style="display: none;">
                            <h5><i class="bi bi-tag"></i> {% trans "Détails du code promotionnel" %}</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.product.id_for_label }}" class="form-label required-field">
                                        {{ form.product.label }}
                                    </label>
                                    {{ form.product }}
                                    {% if form.product.help_text %}
                                        <small class="form-text text-muted">{{ form.product.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.product.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.discount_type.id_for_label }}" class="form-label required-field">
                                        {{ form.discount_type.label }}
                                    </label>
                                    {{ form.discount_type }}
                                    {% if form.discount_type.help_text %}
                                        <small class="form-text text-muted">{{ form.discount_type.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.discount_type.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.discount_value.id_for_label }}" class="form-label required-field">
                                        {{ form.discount_value.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.discount_value }}
                                        <span class="input-group-text discount-type-symbol">%</span>
                                    </div>
                                    {% if form.discount_value.help_text %}
                                        <small class="form-text text-muted">{{ form.discount_value.help_text }}</small>
                                    {% endif %}
                                    {% for error in form.discount_value.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Section Notes optionnelles -->
                        <div class="form-section mb-4">
                            <h5><i class="bi bi-pencil"></i> {% trans "Notes optionnelles" %}</h5>
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    {{ form.notes.label }}
                                </label>
                                {{ form.notes }}
                                {% if form.notes.help_text %}
                                    <small class="form-text text-muted">{{ form.notes.help_text }}</small>
                                {% endif %}
                                {% for error in form.notes.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Bouton de soumission -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'payments:code_dashboard' %}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left me-1"></i> {% trans "Retour" %}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-shield-lock me-1"></i> {% trans "Générer le(s) code(s)" %}
                            </button>
                        </div>
                    </form>
                    
                    <!-- Modal to show generated codes (AJAX) -->
                    <div class="modal fade" id="generatedCodesModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">{% trans "Codes générés" %}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="mb-3">{% trans "Voici les codes générés :" %}</p>
                                    <div id="generated-codes-list" class="mb-3" style="font-family: monospace; column-count: 2; column-gap: 1.5rem;"></div>
                                    <div id="generated-codes-alert" class="alert alert-info d-none"></div>
                                </div>
                                <div class="modal-footer">
                                    <a id="view-codes-link" href="#" class="btn btn-outline-primary" target="_blank">{% trans "Voir la page détaillée" %}</a>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Inclure jQuery (nécessaire pour Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Inclure Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Notre script personnalisé -->
<script src="{% static 'js/code_generation.js' %}"></script>

<script>
    // Initialisation de Select2 pour les champs de sélection
    $(document).ready(function() {
        // Initialiser Select2 pour les champs avec la classe select2
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Sélectionnez une option...',
            allowClear: true
        });

        // Gérer le changement de type de réduction
        $('#id_discount_type').on('change', function() {
            const symbol = $(this).val() === 'percentage' ? '%' : 'FCFA';
            $('.discount-type-symbol').text(symbol);
        });

        // Initialiser le symbole de la réduction au chargement de la page
        const initialSymbol = $('#id_discount_type').val() === 'percentage' ? '%' : 'FCFA';
        $('.discount-type-symbol').text(initialSymbol);
    });
</script>
{% endblock %}
